import requests
from bs4 import BeautifulSoup
from django.shortcuts import render
from .utils import create_pdf
from .forms import CVECodeForm


def index_view(request):
    if request.method == "POST":
        form = CVECodeForm(request.POST)
        if form.is_valid():
            cve_code = form.cleaned_data["cve_code"]

            # create URL
            url = f"https://nvd.nist.gov/vuln/detail/{cve_code}"

            # Get HTML content from URL
            response = requests.get(url)
            if response.status_code == 200:
                html_content = response.content

                # Parse HTML content with BeautifulSoup
                soup = BeautifulSoup(html_content, "html.parser")

                # create PDF
                pdf_response = create_pdf(soup, cve_code, url)

                return pdf_response
    else:
        form = CVECodeForm()

    context = {
        "form": form,
    }
    return render(request, "core/index.html", context)
