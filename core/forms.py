import requests
from bs4 import BeautifulSoup
from django import forms


class CVECodeForm(forms.Form):
    cve_code = forms.CharField(
        required=True,
        label="Enter CVE Code",
        widget=forms.TextInput(
            attrs={"class": "form-control", "placeholder": "CVE-XXXX-XXXX"}
        )
    )

    def clean_cve_code(self):
        cve_code = self.cleaned_data.get("cve_code")

        url = f"https://nvd.nist.gov/vuln/detail/{cve_code}"
        response = requests.get(url)

        # If the request fails, throw an error
        if response.status_code == 200:
            # Parse HTML content with BeautifulSoup
            soup = BeautifulSoup(response.content, "html.parser")
            # Check if the response contains the error message
            if soup.find("h2", text="CVE ID Not Found"):
                raise forms.ValidationError("CVE ID Not Found")
        else:
            raise forms.ValidationError("Failed to retrieve CVE details.")

        return cve_code
