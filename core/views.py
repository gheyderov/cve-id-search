from django.shortcuts import render
from django.http import HttpResponse, JsonResponse

from .utils import create_pdf_from_urls
from .forms import CVECodeForm


def index_view(request):
    if request.method == "POST":
        form = CVECodeForm(request.POST)
        if form.is_valid():
            cve_code = form.cleaned_data["cve_code"]

            # create PDF content
            pdf_content = create_pdf_from_urls(cve_code)

            # create HttpResponse object
            response = HttpResponse(pdf_content, content_type="application/pdf")
            response["Content-Disposition"] = f'inline; filename="{cve_code}.pdf"'
            return response
        else:
            errors = dict(form.errors)
            return JsonResponse({"errors": errors}, status=400)
    else:
        form = CVECodeForm()

    context = {
        "form": form,
    }
    return render(request, "core/index.html", context)
