import json

from django.shortcuts import render
from django.http import HttpResponse, JsonResponse

from .utils import create_pdf_from_urls
from .forms import CVECodeForm


def index_view(request):
    if request.method == "POST":
        form = CVECodeForm(request.POST)
        if form.is_valid():
            cve_code = form.cleaned_data["cve_code"]

            # create PDF content and references to open
            pdf_content, references_to_open = create_pdf_from_urls(cve_code)

            # Convert references_to_open to JSON string
            references_json = json.dumps(references_to_open[:3])

            # create HttpResponse object for PDF
            response = HttpResponse(
                pdf_content, content_type="application/pdf")
            response["Content-Disposition"] = f'inline; filename="{cve_code}.pdf"'
            # Add references_to_open as a custom header
            response["References-To-Open"] = references_json

            # return HttpResponse object
            return response
        else:
            errors = dict(form.errors)
            return JsonResponse({"errors": errors}, status=400)
    else:
        form = CVECodeForm()

    context = {
        "form": form,
    }
    return render(request, "core/index.html", context)
